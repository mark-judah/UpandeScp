[
 {
  "allow_guest": 0,
  "api_method": "getPestsData",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-11 18:17:30.705718",
  "module": "Upande Scp",
  "name": "Get Pests Data",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "try:\n    pests = frappe.get_all(\n        \"Pest\",\n        fields=[\"name\", \"common_name\"]\n    )\n    pest_data = []\n    for pest in pests:\n        stages = frappe.get_all(\n            \"Pests Stages\",\n            filters={\"parent\": pest.name},\n            fields=[\"stage\", \"image\"]\n        )\n        pest_data.append({\n            \"common_name\": pest.common_name,\n            \"stages\": stages\n        })\n    frappe.response[\"data\"] = {\n        \"pests\": pest_data\n    }\n\nexcept Exception as e:\n    frappe.log_error(message=e, title=\"Get pests data error\")\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "createBedsAndZones",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-11 18:17:30.624945",
  "module": "Upande Scp",
  "name": "Zone Atomation Tool",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Bed And Zone Automation",
  "script": "def assign_variety_from_sectors(sectors, bed_number):\n    try:\n        bed_int = int(bed_number)\n    except Exception:\n        return None\n    for sector in sectors:\n        try:\n            if int(sector.from_bed) <= bed_int <= int(sector.to_bed):\n                return sector.sector\n        except Exception:\n            continue\n    return None\n\ndef safe_parse_json(json_string):\n    \"\"\"Parses a JSON string and handles potential errors gracefully.\"\"\"\n    if not json_string:\n        return {}\n    try:\n        return json.loads(json_string)\n    except json.JSONDecodeError as e:\n        frappe.throw(f\"Invalid JSON format: {e}\")\n    except Exception as e:\n        frappe.throw(f\"Error parsing JSON: {e}\")\n\ndoc_name = frappe.form_dict.get(\"doc_name\")\ntry:\n    if not doc_name:\n        frappe.throw(\n            \"Error: Document name is missing. Please save the document and try again.\")\n\n    doc = frappe.get_doc(\"Bed And Zone Automation\", doc_name)\n    beds_created_count = 0\n    zones_created_count = 0\n    skipped_beds_count = 0\n    skipped_zones_count = 0\n\n    greenhouse = doc.name\n    zones_geojson = doc.zones_geojson or \"\"\n    sectors = doc.sectors or []\n\n    for line in zones_geojson.strip().splitlines():\n        if not line.strip():\n            continue\n\n        feature_collection = safe_parse_json(line)\n        if not feature_collection:\n            continue\n            \n        for feature in feature_collection.get(\"features\", []):\n            props = feature.get(\"properties\", {})\n            bed_number = str(props.get(\"line_id\"))\n            zone_number = str(props.get(\"zone_id\"))\n\n            if not bed_number or not zone_number:\n                continue\n\n            variety = assign_variety_from_sectors(sectors, bed_number)\n            \n            # --- Bed ---\n            existing_bed_name = frappe.db.exists({\n                \"doctype\": \"Bed\",\n                \"greenhouse\": greenhouse,\n                \"bed\": bed_number\n            })\n\n            bed_doc = None\n            if existing_bed_name:\n                skipped_beds_count = skipped_beds_count + 1\n                bed_doc = frappe.get_doc(\"Bed\", existing_bed_name)\n            else:\n                try:\n                    bed_doc = frappe.get_doc({\n                        \"doctype\": \"Bed\",\n                        \"greenhouse\": greenhouse,\n                        \"bed\": bed_number,\n                        \"variety\": variety or \"\"  # Ensure variety is an empty string if None\n                    })\n                    bed_doc.insert(ignore_permissions=True)\n                    beds_created_count = beds_created_count + 1\n                except Exception as e:\n                    frappe.log_error(f\"Failed to create Bed: {e}\", \"Bed And Zone Automation Error\")\n                    continue  # Skip to the next feature if bed creation fails\n\n            if not bed_doc:\n                continue\n\n            # --- Zone ---\n            existing_zone_name = frappe.db.exists({\n                \"doctype\": \"Zone\",\n                \"greenhouse\": greenhouse,\n                \"bed\": bed_doc.name,\n                \"zone\": zone_number\n            })\n\n            if existing_zone_name:\n                skipped_zones_count = skipped_zones_count + 1\n            else:\n                try:\n                    zone_doc = frappe.get_doc({\n                        \"doctype\": \"Zone\",\n                        \"greenhouse\": greenhouse,\n                        \"bed\": bed_doc.name,\n                        \"zone\": zone_number,\n                        \"raw_geojson\": line\n                    })\n                    zone_doc.insert(ignore_permissions=True)\n                    zones_created_count = zones_created_count + 1\n                except Exception as e:\n                    frappe.log_error(f\"Failed to create Zone: {e}\", \"Bed And Zone Automation Error\")\n\n    frappe.msgprint(\n        f\"{beds_created_count} beds created, {skipped_beds_count} skipped. \"\n        f\"{zones_created_count} zones created, {skipped_zones_count} skipped.\"\n    )\n\nexcept Exception as e:\n    frappe.throw(f\"Error in Bed & Zone Automation: {e}\")",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "getPlantDiseasesData",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-11 18:17:30.671053",
  "module": "Upande Scp",
  "name": "Get Plant Diseases Data",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "try:\n    plant_diseases = frappe.get_all(\n        \"Plant Disease\",\n        fields=[\"name\", \"common_name\"]\n    )\n    plant_disease_data = []\n    for plant_disease in plant_diseases:\n        stages = frappe.get_all(\n            \"Disease Stages\",\n            filters={\"parent\": plant_disease.name},\n            fields=[\"stage\", \"image\"]\n        )\n        plant_disease_data.append({\n            \"common_name\": plant_disease.common_name,\n            \"stages\": stages\n        })\n    frappe.response[\"data\"] = {\n        \"plant_diseases\": plant_disease_data\n    }\n\nexcept Exception as e:\n    frappe.log_error(message=e, title=\"Get plant diseases data error\")\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "getBomStockBalances",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-11 18:17:30.500494",
  "module": "Upande Scp",
  "name": "Get BOM Stock Balances",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "try:\n    data = frappe.form_dict.get(\"data\")\n    item_names = []\n    if data:\n        item_names = json.loads(data).get(\"chemicals\", [])\n\n    item_code_map = {}\n    code_item_map = {}\n    item_uom_map = {}\n\n    if item_names:\n        items = frappe.get_list(\n            \"Item\",\n            filters={\"item_name\": (\"in\", item_names)},\n            fields=[\"item_name\", \"item_code\", \"stock_uom\"],\n            as_list=False\n        )\n        for item in items:\n            name = item.get(\"item_name\")\n            code = item.get(\"item_code\")\n            stock_uom = item.get(\"stock_uom\")\n            item_code_map[name] = code\n            code_item_map[code] = name\n            item_uom_map[name] = stock_uom\n\n    chemicals = list(item_code_map.values())\n\n    source_warehouses = [\n        'Chemical Store Chepsito - KR',\n        'Chemical Store Kapkolia - KR',\n        'Chemical Store Kaptumbo - KR',\n        'Chemical Store Simotwo - KR',\n        'Chemical Store Torongo - KR'\n    ]\n\n    code_stock_balances = {}\n    if chemicals:\n        bins = frappe.get_list(\n            \"Bin\",\n            filters={\n                \"item_code\": (\"in\", chemicals),\n                \"warehouse\": (\"in\", source_warehouses)\n            },\n            fields=[\"item_code\", \"warehouse\", \"actual_qty\"],\n            as_list=False\n        )\n\n        for chemical_code in chemicals:\n            code_stock_balances[chemical_code] = {}\n            for warehouse in source_warehouses:\n                code_stock_balances[chemical_code][warehouse] = 0.0\n\n        for bin_record in bins:\n            item_code = bin_record.get('item_code')\n            wh = bin_record.get('warehouse')\n            qty = bin_record.get('actual_qty')\n            if item_code in code_stock_balances and wh in code_stock_balances[item_code]:\n                code_stock_balances[item_code][wh] = qty\n\n    final_stock_balances = {}\n    for code, balances in code_stock_balances.items():\n        item_name = code_item_map.get(code)\n\n        if item_name:\n            final_stock_balances[item_name] = balances\n\n    frappe.response[\"data\"] = {\n        \"stock_balances\": final_stock_balances,\n        \"item_uom_map\": item_uom_map\n    }\n\nexcept Exception as e:\n    frappe.log_error(title=\"Server Script Error\", message=str(e))\n    frappe.throw(\"Error fetching stock balances: \" + str(e))\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "getReentryStatus",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-11 18:17:30.466335",
  "module": "Upande Scp",
  "name": "Get Greenhouse Reentry Status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "greenhouse_name = frappe.form_dict.get('greenhouse')\ninput_date = frappe.form_dict.get('date')\n\nif not greenhouse_name or not input_date:\n    frappe.response['http_status_code'] = 400\n    frappe.response['message'] = \"Missing 'greenhouse' and/or 'date' parameter.\"\n    exit()\n\nfilters = [\n    [\"custom_greenhouse\", \"=\", greenhouse_name],\n    [\"docstatus\", \"=\", 1],\n    [\"custom_scheduled_application_time\", \">=\", input_date]\n]\n\nwork_orders = frappe.get_list(\n    doctype=\"Work Order\",\n    filters=filters,\n    fields=[\n        \"name\", \n        \"custom_scheduled_application_time\",\n        \"custom_reentry_time\"\n    ],\n    order_by=\"custom_scheduled_application_time asc\"\n)\n\nfrappe.response['data'] = work_orders",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-11 18:17:30.230913",
  "module": "Upande Scp",
  "name": "Store Updated WO Required Qty",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Work Order",
  "script": "for row in doc.required_items:\n    row.custom_updated_required_qty = row.required_qty",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-11 18:17:30.199178",
  "module": "Upande Scp",
  "name": "Restore Updated WO Required Qty",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Work Order",
  "script": "for row in doc.required_items:\n    if row.get('custom_updated_required_qty'):\n        row.required_qty = row.custom_updated_required_qty",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "fetchScheduledApplications",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-22 15:47:51.093535",
  "module": "Upande Scp",
  "name": "Fetch Scheduled Applications",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "try:\n    start_date = frappe.form_dict.get('start_date')\n\n    filters = {\n        \"docstatus\": 1,\n        \"custom_type\": \"Application Floor Plan\"\n    }\n\n    if start_date:\n        filters[\"custom_scheduled_application_time\"] = [\">=\", start_date]\n\n    work_orders = frappe.get_all(\n        \"Work Order\",\n        filters=filters,\n        fields=[\n            \"name\",\n            \"status\",\n            \"custom_type\",\n            \"custom_greenhouse\",\n            \"custom_scope\",\n            \"custom_scope_details\",\n            \"custom_area\",\n            \"custom_water_volume\",\n            \"custom_water_ph\",\n            \"custom_water_hardness\",\n            \"custom_variety\",\n            \"custom_spray_type\",\n            \"custom_kit\",\n            \"custom_targets\",\n            \"custom_spray_team\",\n            \"custom_reentry_time\",\n            \"custom_scheduled_application_time\",\n            \"wip_warehouse\"\n        ]\n    )\n\n    if work_orders:\n        wo_names = [wo.get('name') for wo in work_orders]\n        \n        required_items_data = frappe.get_all(\n            \"Work Order Item\",\n            filters={\n                \"parent\": (\"in\", wo_names)\n            },\n            fields=[\"parent\", \"item_name\", \"required_qty\", \"stock_uom\"],\n            order_by=\"idx asc\"\n        )\n\n        items_by_wo = {}\n        for item in required_items_data:\n            parent_name = item.pop('parent')\n            if parent_name not in items_by_wo:\n                items_by_wo[parent_name] = []\n            items_by_wo[parent_name].append(item)\n\n        for wo in work_orders:\n            wo['required_items'] = items_by_wo.get(wo['name'], [])\n\n    frappe.response.data = work_orders\n\nexcept Exception as e:\n    frappe.response.status = 500\n    frappe.response.message = \"An error occurred while fetching Work Orders.\"\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "fetchGreenhouseBeds",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-24 01:26:05.262159",
  "module": "Upande Scp",
  "name": "Fetch Greenhouse Beds",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "try:\n    greenhouse_name = frappe.form_dict.get(\"greenhouse_name\")\n\n    if not greenhouse_name:\n        frappe.response['message'] = \"Greenhouse name parameter 'greenhouse_name' is missing.\"\n    else:\n        beds_list = frappe.db.get_list(\n            \"Bed\",\n            filters={\"greenhouse\": greenhouse_name},\n            fields=[\"bed\", \"name\"]\n        )\n\n        frappe.response['data'] = beds_list\n\nexcept Exception as e:\n    frappe.response['message'] = \"An unexpected server error occurred: \" + str(e)\n",
  "script_type": "API"
 }
]