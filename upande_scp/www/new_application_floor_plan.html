{% extends "upande_scp/www/base.html" %}
{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  /* ==================== GRID STYLES ==================== */
  .grid-container-wrapper {
    background: #ffffff;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    height: calc(200vh);
    min-height: 600px;
    display: flex;
    flex-direction: column;
  }

  #heatmap-grid-wrapper {
    display: grid;
    grid-template-columns: 60px 1fr;
    grid-template-rows: 40px 1fr;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #ffffff;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  #x-axis-labels {
    grid-column: 2 / 3;
    grid-row: 1 / 2;
    display: grid;
    grid-template-columns: repeat(var(--zones-per-bed), minmax(50px, 1fr));
    background: linear-gradient(to bottom, #1f2937, #111827);
    border-bottom: 2px solid #374151;
    align-items: center;
  }

  #x-axis-labels>div {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 700;
    color: #ffffff;
    padding: 10px 4px;
    border-right: 1px solid #374151;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  #x-axis-labels>div:last-child {
    border-right: none;
  }

  #y-axis-labels {
    grid-column: 1 / 2;
    grid-row: 2 / 3;
    display: grid;
    grid-template-rows: repeat(var(--num-beds), minmax(45px, 1fr));
    background: linear-gradient(to right, #1f2937, #111827);
    border-right: 2px solid #374151;
    overflow-y: auto;
    overflow-x: hidden;
  }

  #y-axis-labels>div {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 700;
    color: #ffffff;
    padding: 4px 6px;
    border-bottom: 1px solid #374151;
    display: flex;
    align-items: center;
    justify-content: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  #y-axis-labels>div:last-child {
    border-bottom: none;
  }

  /* Hide scrollbar for y-axis labels but keep functionality */
  #y-axis-labels::-webkit-scrollbar {
    width: 0;
    display: none;
  }

  #heatmap-grid-wrapper::before {
    content: "BED/ZONE";
    grid-column: 1 / 2;
    grid-row: 1 / 2;
    background: linear-gradient(135deg, #1f2937, #111827);
    border-right: 2px solid #374151;
    border-bottom: 2px solid #374151;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    font-weight: 700;
    color: #9ca3af;
    letter-spacing: 0.5px;
  }

  #main-grid {
    grid-column: 2 / 3;
    grid-row: 2 / 3;
    display: grid;
    grid-template-columns: repeat(var(--zones-per-bed), minmax(50px, 1fr));
    grid-template-rows: repeat(var(--num-beds), minmax(45px, 1fr));
    background: #ffffff;
    overflow: auto;
    position: relative;
  }

  /* Custom scrollbar for main grid */
  #main-grid::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }

  #main-grid::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 5px;
  }

  #main-grid::-webkit-scrollbar-thumb {
    background: #9ca3af;
    border-radius: 5px;
  }

  #main-grid::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
  }

  /* Sync scroll between y-axis and main grid */
  #main-grid::-webkit-scrollbar-corner {
    background: #f3f4f6;
  }

  .tw-grid-cell {
    position: relative;
    background-color: #fafafa;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-height: 45px;
    padding: 4px;
    border-right: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
  }

  .tw-grid-cell:hover {
    background-color: #f0f9ff;
    outline: 2px solid #3b82f6;
    outline-offset: -2px;
    z-index: 50;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
  }

  .observation-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
  }

  .observation-dots-container {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    padding: 4px;
    align-items: center;
    justify-content: center;
  }

  .tw-grid-cell.tw-threshold-high {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    box-shadow: inset 0 0 0 3px #dc2626;
  }

  .tw-grid-cell.tw-threshold-moderate {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    box-shadow: inset 0 0 0 3px #f59e0b;
  }

  .tw-grid-cell.tw-threshold-low {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    box-shadow: inset 0 0 0 2px #10b981;
  }

  .tw-tooltip {
    position: fixed;
    background-color: rgba(17, 24, 39, 0.98);
    color: #ffffff;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.8rem;
    line-height: 1.6;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 9999;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.15);
    max-width: 350px;
    white-space: normal;
  }

  .tw-grid-cell:hover .tw-tooltip {
    opacity: 1;
  }

  /* ==================== FORM STYLES ==================== */
  .form-section {
    background: #ffffff;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .form-section-title {
    font-size: 1rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
  }

  .form-input,
  .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    background: #ffffff;
  }

  .form-input:focus,
  .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
  }

  .form-input:disabled {
    background: #f3f4f6;
    color: #6b7280;
    cursor: not-allowed;
  }

  /* Filter Pills */
  .filter-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .filter-pill {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    background: #f3f4f6;
    border: 1.5px solid #d1d5db;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-pill input[type="checkbox"] {
    margin-right: 6px;
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: #3b82f6;
  }

  .filter-pill:has(input:checked) {
    background: #dbeafe;
    border-color: #3b82f6;
    color: #1e40af;
  }

  .filter-pill:has(input:disabled) {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .observation-section {
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .observation-title {
    font-size: 0.8rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ==================== TABLE STYLES ==================== */
  .stock-table-container {
    background: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-top: 24px;
  }

  .stock-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.875rem;
  }

  .stock-table thead {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    color: #ffffff;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .stock-table th {
    padding: 14px 12px;
    font-weight: 600;
    text-align: left;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #374151;
  }

  .stock-table tbody tr {
    transition: background 0.15s ease;
    border-bottom: 1px solid #e5e7eb;
  }

  .stock-table tbody tr:hover {
    background: #f9fafb;
  }

  .stock-table td {
    padding: 12px;
    border-right: 1px solid #e5e7eb;
  }

  .stock-table td:first-child {
    font-weight: 600;
    color: #1f2937;
    background: #f9fafb;
  }

  .stock-qty-zero {
    color: #ef4444;
    font-weight: 700;
  }

  .stock-qty-available {
    color: #059669;
    font-weight: 600;
  }

  .stock-total {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    font-weight: 700;
    color: #1e40af;
  }

  .stock-total-insufficient {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
  }

  /* Chemical List */
  .chemical-list {
    background: #f9fafb;
    border-radius: 8px;
    max-height: 400px;
    overflow-y: auto;
  }

  .chemical-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 12px;
    align-items: center;
    padding: 12px;
    background: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    transition: background 0.15s ease;
  }

  .chemical-row:hover {
    background: #f9fafb;
  }

  .chemical-row input {
    padding: 8px 10px;
    border: 1.5px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.8rem;
  }

  .btn-remove {
    padding: 6px 12px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
    transition: all 0.2s ease;
  }

  .btn-remove:hover {
    background: #dc2626;
    transform: scale(1.05);
  }

  .btn-primary {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .btn-secondary {
    background: #ffffff;
    color: #1f2937;
    border: 2px solid #e5e7eb;
  }

  .btn-secondary:hover {
    background: #f9fafb;
  }

  /* Popup Styles */
  .popup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 50;
  }

  .popup-overlay.active {
    display: block;
  }

  .popup {
    position: absolute;
    width: 280px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }

  .popup-search {
    width: 100%;
    padding: 12px;
    border: none;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.875rem;
  }

  .popup-content {
    max-height: 280px;
    overflow-y: auto;
  }

  .popup-item {
    display: block;
    padding: 10px 12px;
    color: #374151;
    text-decoration: none;
    transition: background 0.15s ease;
    border-bottom: 1px solid #f3f4f6;
  }

  .popup-item:hover {
    background: #f9fafb;
  }

  /* Status Message */
  .status-message {
    text-align: center;
    padding: 60px 20px;
    font-size: 1.1rem;
    color: #6b7280;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border-radius: 12px;
    border: 2px dashed #d1d5db;
    font-weight: 500;
  }

  .status-message::before {
    display: block;
    font-size: 3rem;
    margin-bottom: 16px;
  }

  /* Loader */
  #map-loader {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f4f6;
    border-top: 5px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .form-section {
      padding: 16px;
    }

    .chemical-row {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}
{% block page_content %}
<div class="tw-bg-gray-50 tw-p-8 tw-min-h-screen">
  <div id="map-loader">
    <div class="spinner"></div>
    <p class="tw-mt-4 tw-text-gray-700 tw-font-medium">Loading data...</p>
  </div>
  <div class="tw-grid tw-grid-cols-1 lg:tw-grid-cols-3 tw-gap-6">
    <!-- LEFT PANEL: Form -->
    <div class="lg:tw-col-span-1">
      <form id="spray-plan-form" class="tw-space-y-6">
        <!-- Basic Info Section -->
        <div class="form-section">
          <h3 class="form-section-title">Basic Information</h3>
          <div class="form-group">
            <label class="form-label" for="scouting-date">Date</label>
            <input type="date" id="scouting-date" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="greenhouse">Greenhouse</label>
            <select id="greenhouse" class="form-select" required>
              <option value="">Select greenhouse</option>
              {% for warehouse in warehouses_list %}
              <option value="{{ warehouse.name }}">{{ warehouse.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="variety">Variety</label>
            <select id="variety" class="form-select" required>
              <option value="">Select variety</option>
            </select>
          </div>
        </div>
        <!-- Filters Section -->
        <div class="form-section">
          <h3 class="form-section-title">Filters</h3>
          <div id="targets-container"></div>
          <div class="form-group">
            <label class="form-label">Stages</label>
            <div id="stages-container" class="filter-group"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Plant Sections</label>
            <div id="plant-section-container" class="filter-group"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Chemical Requirements</label>
            <p id="threshold-message" class="tw-text-sm tw-text-amber-600 tw-mb-2 tw-hidden"></p>
            <div class="tw-text-xs tw-text-gray-500 tw-mb-2">Based on zones covered vs total zones</div>
            <div id="threshold-container" class="filter-group"></div>
          </div>
        </div>
        <!-- Spray Details Section -->
        <div class="form-section">
          <h3 class="form-section-title">Spray Details</h3>
          <div class="form-group">
            <label class="form-label" for="spray-type">Spray Type</label>
            <select id="spray-type" class="form-select" required>
              <option value="">Select type</option>
              <option value="Full">Full</option>
              <option value="Under">Under</option>
              <option value="Top">Top</option>
              <option value="Full + Top">Full + Top</option>
              <option value="Full + Under">Full + Under</option>
              <option value="Outside">Outside</option>
              <option value="Drench">Drench</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="kit">Kit</label>
            <select id="kit" class="form-select" required>
              <option value="">Select kit</option>
              <option value="Kit A">Kit A</option>
              <option value="Kit B">Kit B</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="scope">Scope</label>
            <select id="scope" class="form-select" required>
              <option value="">Select scope</option>
              <option value="Full Greenhouse">Full Greenhouse</option>
              <option value="Specific Variety">Specific Variety</option>
              <option value="Specific Bed(s)">Specific Bed(s)</option>
            </select>
          </div>
          <div id="bed-numbers-container" class="form-group tw-hidden">
            <label class="form-label" for="bed-numbers">Bed Numbers</label>
            <input type="text" id="bed-numbers" class="form-input" placeholder="e.g., 1, 3, 5-8, 12">
            <small class="tw-text-gray-500 tw-text-xs">Enter bed numbers or ranges, separated by commas</small>
          </div>
          <div id="variety-selection-container" class="form-group tw-hidden">
            <label class="form-label" for="variety-multiselect">Select Varieties</label>
            <select id="variety-multiselect" multiple class="form-select" style="min-height: 100px;"></select>
            <div id="selected-varieties-display" class="tw-mt-2 tw-p-3 tw-bg-gray-50 tw-rounded-lg tw-text-sm">
              <p class="tw-text-gray-500">Selected varieties will appear here...</p>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="area_to_spray">Area to Spray (Ha)</label>
            <input type="number" id="area_to_spray" class="form-input" step="any" readonly>
          </div>
          <div class="form-group">
            <label class="form-label" for="spray-team-select">Spray Team</label>
            <select id="spray-team-select" class="form-select" required></select>
          </div>
        </div>
        <!-- BOM Section -->
        <div class="form-section">
          <h3 class="form-section-title">Bill of Materials</h3>
          <div class="form-group">
            <label class="form-label" for="bom">BOM</label>
            <select id="bom" class="form-select" required>
              <option value="">Select BOM</option>
            </select>
          </div>
          <div id="bom-details-container" class="tw-hidden tw-space-y-4">
            <div class="tw-grid tw-grid-cols-2 tw-gap-4">
              <div class="form-group">
                <label class="form-label" for="custom_water_ph">Water PH</label>
                <input type="text" id="custom_water_ph" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label" for="custom_water_hardness">Water Hardness</label>
                <input type="text" id="custom_water_hardness" class="form-input">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Chemicals (Per Ha)</label>
              <div class="chemical-list">
                <div
                  class="tw-grid tw-grid-cols-4 tw-gap-4 tw-p-3 tw-bg-gray-100 tw-font-semibold tw-text-xs tw-uppercase">
                  <div>Chemical</div>
                  <div>Qty</div>
                  <div>UoM</div>
                  <div>Action</div>
                </div>
                <div id="bom-chemicals-list"></div>
              </div>
              <button type="button" id="add-chemical-btn" class="btn-primary btn-secondary tw-w-full tw-mt-3">
                + Add Chemical
              </button>
            </div>
            <div class="form-group">
              <label class="form-label" for="custom_water_volume">Volume (Litres/Ha)</label>
              <input type="text" id="custom_water_volume" class="form-input">
            </div>
          </div>
        </div>
        <button type="submit" class="btn-primary tw-w-full">Create Spray Plan</button>
      </form>
    </div>
    <!-- RIGHT PANEL: Grid & Table -->
    <div class="lg:tw-col-span-2 tw-space-y-6">
      <!-- Heatmap Grid -->
      <div class="grid-container-wrapper">
        <div id="heatmap-grid-wrapper" class="tw-hidden">
          <div id="x-axis-labels"></div>
          <div id="y-axis-labels"></div>
          <div id="main-grid"></div>
        </div>
      </div>
      <!-- Stock Balance Table -->
      <div id="stock-balances-container" class="stock-table-container tw-hidden">
        <div class="tw-overflow-x-auto">
          <table class="stock-table">
            <thead>
              <tr>
                <th rowspan="2">Chemical</th>
                <th id="warehouse-group-header" class="tw-text-center">Warehouses</th>
                <th rowspan="2" class="tw-text-center">Source</th>
                <th rowspan="2" class="tw-text-center">Total</th>
              </tr>
              <tr id="warehouse-headers-row"></tr>
            </thead>
            <tbody id="stock-balance-table-body">
              <tr>
                <td colspan="10" class="tw-text-center tw-py-6 tw-text-gray-500">
                  No chemicals selected or loading data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Global Popup -->
  <div id="global-popup-overlay" class="popup-overlay">
    <div id="global-popup" class="popup">
      <input type="text" id="global-popup-search" class="popup-search" placeholder="Search...">
      <div id="global-popup-content" class="popup-content"></div>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // ==================== STATE & CACHE ====================
    const state = {
      scoutingData: [],
      varietyRequirements: new Map(),
      dataMap: new Map(),
      bomsData: [],
      bomItems: [],
      allChemicals: [],
      bedData: [],
      teamData: [],
      observationMetadata: {},
      allObservationNames: {},
      activeObservationTypes: [],
      sourceWarehouseCache: {},
      chemicalUomCache: {},
      susceptibilityData: [] // NEW: Store susceptibility
    };
    // ==================== DOM ELEMENTS ====================
    const els = {
      greenhouse: document.getElementById("greenhouse"),
      variety: document.getElementById("variety"),
      sprayType: document.getElementById("spray-type"),
      kit: document.getElementById("kit"),
      scope: document.getElementById("scope"),
      bom: document.getElementById("bom"),
      areaToSpray: document.getElementById("area_to_spray"),
      bedNumbers: document.getElementById("bed-numbers"),
      waterPh: document.getElementById("custom_water_ph"),
      waterHardness: document.getElementById("custom_water_hardness"),
      waterVolume: document.getElementById("custom_water_volume"),
      sprayTeam: document.getElementById("spray-team-select"),
      varietyMultiSelect: document.getElementById("variety-multiselect"),
      selectedVarietiesDisplay: document.getElementById("selected-varieties-display"),
      bomChemicalsList: document.getElementById("bom-chemicals-list"),
      addChemicalBtn: document.getElementById("add-chemical-btn"),
      mainGrid: document.getElementById("main-grid"),
      xAxisLabels: document.getElementById("x-axis-labels"),
      yAxisLabels: document.getElementById("y-axis-labels"),
      heatmapGridWrapper: document.getElementById("heatmap-grid-wrapper"),
      thresholdMessage: document.getElementById("threshold-message"),
      bedNumbersContainer: document.getElementById("bed-numbers-container"),
      varietySelectionContainer: document.getElementById("variety-selection-container"),
      bomDetailsContainer: document.getElementById("bom-details-container"),
      stockBalancesContainer: document.getElementById("stock-balances-container"),
      stockBalanceTableBody: document.getElementById("stock-balance-table-body"),
      warehouseGroupHeader: document.getElementById("warehouse-group-header"),
      warehouseHeadersRow: document.getElementById("warehouse-headers-row"),
      targetsContainer: document.getElementById("targets-container"),
      stagesContainer: document.getElementById("stages-container"),
      plantSectionContainer: document.getElementById("plant-section-container"),
      thresholdContainer: document.getElementById("threshold-container"),
      popupOverlay: document.getElementById("global-popup-overlay"),
      popup: document.getElementById("global-popup"),
      popupSearch: document.getElementById("global-popup-search"),
      popupContent: document.getElementById("global-popup-content")
    };
    // ==================== UTILITY FUNCTIONS ====================
    const showLoader = () => document.getElementById('map-loader').style.display = 'flex';
    const hideLoader = () => document.getElementById('map-loader').style.display = 'none';
    const parseBedNumber = (bedString) => {
      const match = bedString.match(/Bed (\d+)/);
      return match ? parseInt(match[1]) : null;
    };
    const getZoneNumber = (zoneData) => {
      if (typeof zoneData === "number") return zoneData;
      if (typeof zoneData === "string") {
        const match = zoneData.match(/Zone (\d+)/);
        if (match) return parseInt(match[1]);
      }
      return null;
    };
    const findMaxDimensions = (data) => {
      let maxBed = 0, maxZone = 0;
      data.forEach((entry) => {
        const bedNum = parseBedNumber(entry.bed);
        const zoneNum = getZoneNumber(entry.zone);
        if (bedNum > maxBed) maxBed = bedNum;
        if (zoneNum > maxZone) maxZone = zoneNum;
      });
      return { maxBed, maxZone };
    };
    // ==================== POPUP FUNCTIONS ====================
    const showPopup = (inputElement, dataCache) => {
      els.popup.dataset.targetInputId = inputElement.id || (inputElement.id = `input-${Date.now()}`);
      const inputRect = inputElement.getBoundingClientRect();
      const popupHeight = 300;
      let topPosition = inputRect.bottom + 5;
      if (window.innerHeight - inputRect.bottom < popupHeight && inputRect.top > popupHeight) {
        topPosition = inputRect.top - popupHeight - 5;
      }
      els.popup.style.top = `${topPosition}px`;
      els.popup.style.left = `${inputRect.left}px`;
      els.popupContent.innerHTML = '';
      dataCache.forEach((item) => {
        const option = document.createElement("a");
        option.href = "#";
        option.textContent = item;
        option.className = "popup-item";
        option.addEventListener("click", (e) => {
          e.preventDefault();
          inputElement.value = item;
          els.popupOverlay.classList.remove('active');
          els.popupSearch.value = '';
          updateStockBalances();
        });
        els.popupContent.appendChild(option);
      });
      els.popupSearch.value = inputElement.value;
      els.popupSearch.oninput = filterPopup;
      els.popupOverlay.classList.add('active');
      filterPopup();
      els.popupSearch.focus();
    };
    const filterPopup = () => {
      const filterText = els.popupSearch.value.toUpperCase();
      Array.from(els.popupContent.children).forEach(option => {
        option.style.display = option.textContent.toUpperCase().includes(filterText) ? 'block' : 'none';
      });
    };
    // ==================== DATA PROCESSING ====================
    const processScoutingData = (scoutingEntries) => {
      const dataMap = new Map();
      const observationsInGreenhouse = {};
      const stagesInGreenhouse = new Set();
      const sectionsInGreenhouse = new Set();

      // Initialise every possible observation type
      // Accept both '_scouting_entry' and '_entry' suffixes
      const allPossibleTypes = state.activeObservationTypes.filter(t =>
        t.endsWith('_scouting_entry') || t.endsWith('_entry')
      );
      allPossibleTypes.forEach(t => observationsInGreenhouse[t] = new Set());

      // Always add "N/A" as default stage and section for observations without these fields
      stagesInGreenhouse.add("N/A");
      sectionsInGreenhouse.add("N/A");

      scoutingEntries.forEach((entry) => {
        const bedNum = parseBedNumber(entry.bed);
        const zoneNum = getZoneNumber(entry.zone);
        if (!bedNum || !zoneNum) return;

        const key = `${bedNum}-${zoneNum}`;
        if (!dataMap.has(key)) dataMap.set(key, []);
        const observations = dataMap.get(key);

        allPossibleTypes.forEach(obsType => {
          const obsArray = entry[obsType] || [];

        
          obsArray.forEach((obs) => {
            // Add to greenhouse observations Set
            observationsInGreenhouse[obsType].add(obs.name);

            // Add stage if present, otherwise use "N/A"
            const stage = obs.stage || "N/A";
            const plantSection = obs.plant_section || "N/A";

            stagesInGreenhouse.add(stage);
            sectionsInGreenhouse.add(plantSection);

            observations.push({
              type: obsType,
              name: obs.name,
              count: obs.count || 1,
              stage: stage,
              symbol: obs.symbol || "",
              color: obs.color || "#cccccc",
              plant_section: plantSection
            });
          });
        });
      });

      // Sort observations in each zone
      dataMap.forEach((observations, key) => {
        dataMap.set(key, observations.sort((a, b) => a.name.localeCompare(b.name)));
      });
      return { dataMap, observationsInGreenhouse, stagesInGreenhouse, sectionsInGreenhouse };
    };
    // ==================== RENDERING FUNCTIONS ====================
    const renderGrid = (numBeds, zonesPerBed, bedNumbering, zoneNumbering) => {
      els.mainGrid.innerHTML = "";
      els.xAxisLabels.innerHTML = "";
      els.yAxisLabels.innerHTML = "";
      document.documentElement.style.setProperty("--num-beds", numBeds);
      document.documentElement.style.setProperty("--zones-per-bed", zonesPerBed);
      const zoneRange = zoneNumbering === "Right to Left"
        ? Array.from({ length: zonesPerBed }, (_, i) => zonesPerBed - i)
        : Array.from({ length: zonesPerBed }, (_, i) => i + 1);
      zoneRange.forEach((i) => {
        const label = document.createElement("div");
        label.textContent = `Z${i}`;
        els.xAxisLabels.appendChild(label);
      });
      const bedRange = bedNumbering === "Top to Bottom"
        ? Array.from({ length: numBeds }, (_, i) => numBeds - i)
        : Array.from({ length: numBeds }, (_, i) => i + 1);
      bedRange.forEach((i) => {
        const label = document.createElement("div");
        label.textContent = `B${i}`;
        els.yAxisLabels.appendChild(label);
      });
      for (let bed = numBeds; bed >= 1; bed--) {
        for (let zone = zonesPerBed; zone >= 1; zone--) {
          const cell = document.createElement("div");
          cell.classList.add("tw-grid-cell");
          cell.dataset.bed = bed;
          cell.dataset.zone = zone;
          const tooltip = document.createElement("div");
          tooltip.classList.add("tw-tooltip");
          tooltip.innerHTML = `<strong>Bed ${bed}, Zone ${zone}</strong><br>No observations reported.`;
          cell.appendChild(tooltip);
          els.mainGrid.appendChild(cell);
        }
      }
      els.mainGrid.addEventListener('scroll', () => {
        els.yAxisLabels.scrollTop = els.mainGrid.scrollTop;
      });
    };
    const updateGrid = () => {
      if (!els.greenhouse.value || state.scoutingData.length === 0) return;

      const { activeObs, activeStages, activeSections, activeRequirements } = getActiveFilters();
      const selectedVariety = els.variety.value;

      const TYPE_MAP = {
        'diseases_scouting_entry': 'disease',
        'pests_scouting_entry': 'pest',
        'weeds_scouting_entry': 'weed',
        'physiological_disorders_entry': 'physiological_disorder',
        'incidents_scouting_entry': 'incident'
      };

      document.querySelectorAll(".tw-grid-cell").forEach((cell) => {
        const bed = cell.dataset.bed;
        const zone = cell.dataset.zone;
        const key = `${bed}-${zone}`;
        const observationsInZone = state.dataMap.get(key) || [];
        const tooltip = cell.querySelector(".tw-tooltip");

        // Debug incidents
        const hasIncidents = observationsInZone.some(obs => obs.type === 'incidents_scouting_entry');
       
        // Reset cell
        cell.innerHTML = "";
        cell.appendChild(tooltip);
        cell.classList.remove("tw-threshold-high", "tw-threshold-moderate", "tw-threshold-low");
        cell.style.backgroundColor = "";

        const filteredObs = observationsInZone.filter((obs) => {
          const obsType = obs.type;
          const activeObsOfType = activeObs[obsType] || [];

          // Check if observation name is in active filters
          const isObservationActive = activeObsOfType.includes(obs.name);

          // For stage: if obs.stage is "N/A", always pass; otherwise check if it's in activeStages
          const isStageActive = obs.stage === "N/A" || activeStages.includes(obs.stage);

          // For plant_section: if obs.plant_section is "N/A", always pass; otherwise check if it's in activeSections
          const isSectionActive = obs.plant_section === "N/A" || activeSections.includes(obs.plant_section);

          return isObservationActive && isStageActive && isSectionActive;
        });

        let highestAlertLevel = 0;
        let tooltipContent = `<strong>Bed ${bed}, Zone ${zone}</strong><br><br>`;

        if (filteredObs.length > 0) {
          filteredObs.forEach((obs) => {
            // Create observation indicator (dot)
            const indicator = document.createElement("div");
            indicator.classList.add("observation-indicator");
            indicator.style.backgroundColor = obs.color;
            indicator.title = obs.name;
            cell.appendChild(indicator);

            // Susceptibility logic
            const obsTypeClean = TYPE_MAP[obs.type] || obs.type.replace('_scouting_entry', '');
            const sus = state.susceptibilityData.find(s =>
              s.observation === obs.name && s.type === obsTypeClean
            );

            let reqLevel = null;
            if (selectedVariety && sus && sus.requirement_by_variety[selectedVariety]) {
              const level = sus.requirement_by_variety[selectedVariety];
              reqLevel = (level === "unknown") ? null : level;
            }

            if (sus && reqLevel && activeRequirements.includes(reqLevel)) {
              if (reqLevel === "high") highestAlertLevel = Math.max(highestAlertLevel, 3);
              else if (reqLevel === "moderate") highestAlertLevel = Math.max(highestAlertLevel, 2);
              else if (reqLevel === "low") highestAlertLevel = Math.max(highestAlertLevel, 1);
            }

            tooltipContent += `• <strong>${obs.name}</strong>: ${obs.count || 1} ${obs.symbol || ""}<br>`;
            tooltipContent += ` <span style="color: #9ca3af;">Section: ${obs.plant_section || "N/A"}</span><br>`;
          });

          if (highestAlertLevel === 3) cell.classList.add("tw-threshold-high");
          else if (highestAlertLevel === 2) cell.classList.add("tw-threshold-moderate");
          else if (highestAlertLevel === 1) cell.classList.add("tw-threshold-low");

        } else if (observationsInZone.length > 0) {
          cell.style.backgroundColor = "#f8f9fa";
          tooltipContent += `<span style="color: #9ca3af;">Observations present but not in active filters</span><br><br>`;
          observationsInZone.forEach((obs) => {
            tooltipContent += `• <strong>${obs.name}</strong>: ${obs.count || 1}<br>`;
            tooltipContent += ` <span style="color: #9ca3af;">${obs.plant_section || "N/A"}</span><br>`;
          });
        } else {
          cell.style.backgroundColor = "#f8f9fa";
          tooltipContent += `<span style="color: #9ca3af;">No observations reported</span>`;
        }

        tooltip.innerHTML = tooltipContent;

        cell.addEventListener('mouseenter', (e) => {
          const cellRect = cell.getBoundingClientRect();
          const tooltipEl = cell.querySelector('.tw-tooltip');

          if (cellRect.top > window.innerHeight / 2) {
            tooltipEl.style.bottom = '100%';
            tooltipEl.style.top = 'auto';
            tooltipEl.style.marginBottom = '8px';
          } else {
            tooltipEl.style.top = '100%';
            tooltipEl.style.bottom = 'auto';
            tooltipEl.style.marginTop = '8px';
          }

          if (cellRect.left < window.innerWidth / 3) {
            tooltipEl.style.left = '0';
            tooltipEl.style.transform = 'translateX(0)';
          } else if (cellRect.right > (window.innerWidth * 2 / 3)) {
            tooltipEl.style.right = '0';
            tooltipEl.style.transform = 'translateX(0)';
          } else {
            tooltipEl.style.left = '50%';
            tooltipEl.style.transform = 'translateX(-50%)';
          }
        });
      });
    };
    // ==================== FIX 1: AUTO-CHECK + NEVER DISABLE ====================
    const renderObservationCheckboxes = (observationsInGreenhouse) => {
      els.targetsContainer.innerHTML = '';


      state.activeObservationTypes.forEach(obsType => {
        const typeLabel = state.observationMetadata.type_labels?.[obsType]
          || obsType.replace('_scouting_entry', '').replace('_entry', '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        const observationsOfType = observationsInGreenhouse[obsType] || new Set();
        const metadataList = state.allObservationNames[obsType] || [];

        // ALWAYS show the section, even if no data exists
        const section = document.createElement('div');
        section.className = 'observation-section';

        const header = document.createElement('div');
        header.className = 'observation-title';
        header.textContent = typeLabel;
        section.appendChild(header);

        const filterGroup = document.createElement('div');
        filterGroup.className = 'filter-group';

        // Merge metadata and actual observations
        const allObservationNames = new Set();

        // Add metadata observations
        metadataList.forEach(o => {
          const name = o.name || o;
          allObservationNames.add(name);
        });

        // Add actual observations from data
        observationsOfType.forEach(name => {
          allObservationNames.add(name);
        });

        const namesToShow = Array.from(allObservationNames).sort();

        if (namesToShow.length === 0) {
          // Show placeholder if no observations exist
          const placeholder = document.createElement('div');
          placeholder.className = 'tw-text-sm tw-text-gray-500 tw-italic';
          placeholder.textContent = 'No observations available';
          filterGroup.appendChild(placeholder);
        } else {
          namesToShow.forEach(obsName => {
            const pill = document.createElement('label');
            pill.className = 'filter-pill';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `obs-${obsType}-${obsName}`;
            checkbox.value = obsName;
            checkbox.dataset.obsType = obsType;

            // Check if this observation exists in the current greenhouse data
            const isInData = observationsOfType.has(obsName);
            checkbox.checked = isInData;
            checkbox.disabled = false;

            const label = document.createElement('span');
            label.textContent = obsName;

            pill.appendChild(checkbox);
            pill.appendChild(label);
            filterGroup.appendChild(pill);
          });
        }

        section.appendChild(filterGroup);
        els.targetsContainer.appendChild(section);
      });
    };

    const renderStageCheckboxes = (stagesInGreenhouse) => {
      els.stagesContainer.innerHTML = "";
      stagesInGreenhouse.forEach((stage) => {
        const pill = document.createElement("label");
        pill.className = "filter-pill";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `stage-${stage}`;
        checkbox.value = stage;
        checkbox.checked = true;
        const label = document.createElement("span");
        label.textContent = stage;
        pill.appendChild(checkbox);
        pill.appendChild(label);
        els.stagesContainer.appendChild(pill);
      });
    };
    const renderPlantSectionCheckboxes = (sectionsInGreenhouse) => {
      const sections = ['Base', 'Stem', 'Middle', 'Top', 'Buds'];
      els.plantSectionContainer.innerHTML = "";
      sections.forEach((section) => {
        const pill = document.createElement("label");
        pill.className = "filter-pill";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `section-${section}`;
        checkbox.value = section;
        checkbox.checked = sectionsInGreenhouse.includes(section);
        checkbox.disabled = !sectionsInGreenhouse.includes(section);
        const label = document.createElement("span");
        label.textContent = section;
        pill.appendChild(checkbox);
        pill.appendChild(label);
        els.plantSectionContainer.appendChild(pill);
      });
    };
    const renderThresholdCheckboxes = (varietyName) => {
      const thresholds = ['low', 'moderate', 'high'];
      const hasData = state.susceptibilityData.length > 0 && varietyName;
      els.thresholdContainer.innerHTML = "";
      thresholds.forEach((threshold) => {
        const pill = document.createElement("label");
        pill.className = "filter-pill";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `threshold-${threshold}`;
        checkbox.value = threshold;
        checkbox.checked = hasData;
        checkbox.disabled = !hasData;
        const label = document.createElement("span");
        label.textContent = threshold.charAt(0).toUpperCase() + threshold.slice(1);
        pill.appendChild(checkbox);
        pill.appendChild(label);
        els.thresholdContainer.appendChild(pill);
      });
      if (hasData) {
        els.thresholdMessage.classList.add("tw-hidden");
      } else {
        els.thresholdMessage.innerHTML = `<strong>No susceptibility data for this variety.</strong>`;
        els.thresholdMessage.classList.remove("tw-hidden");
      }
    };
    const renderStockTable = (balances, allWarehouses) => {
      els.stockBalancesContainer.classList.remove("tw-hidden");
      els.warehouseGroupHeader.setAttribute("colspan", allWarehouses.length);
      let headerHtml = "";
      allWarehouses.forEach(wh => {
        headerHtml += `<th class="tw-text-center">${wh.split(" ")[2]}</th>`;
      });
      els.warehouseHeadersRow.innerHTML = headerHtml;
      let bodyHtml = "";
      const sortedItems = Object.keys(balances).sort();
      sortedItems.forEach(itemName => {
        const itemBalances = balances[itemName];
        let totalStock = 0;
        state.sourceWarehouseCache[itemName] = state.sourceWarehouseCache[itemName] || { source_warehouse: null };
        let warehouseBalanceHtml = "";
        let selectOptionsHtml = '<option value="">-- Select Source --</option>';
        allWarehouses.forEach(wh => {
          const qty = itemBalances[wh] || 0.0;
          totalStock += qty;
          const qtyFormatted = qty.toFixed(2);
          const qtyClass = qty === 0.0 ? "stock-qty-zero" : "stock-qty-available";
          warehouseBalanceHtml += `<td class="tw-text-center ${qtyClass}">${qtyFormatted}</td>`;
          if (qty > 0) {
            const shortWhName = wh.split(" - ")[0];
            selectOptionsHtml += `<option value="${wh}">${shortWhName} (${qtyFormatted})</option>`;
          }
        });
        const totalClass = totalStock === 0.0 ? "stock-total stock-total-insufficient" : "stock-total";
        bodyHtml += `<tr>`;
        bodyHtml += `<td>${itemName}</td>`;
        bodyHtml += warehouseBalanceHtml;
        bodyHtml += `<td><select id="select-wh-${itemName}" class="form-select" data-item-code="${itemName}" onchange="handleWarehouseChange(this)">${selectOptionsHtml}</select></td>`;
        bodyHtml += `<td class="tw-text-center ${totalClass}">${totalStock.toFixed(2)}</td>`;
        bodyHtml += "</tr>";
      });
      els.stockBalanceTableBody.innerHTML = bodyHtml || `<tr><td colspan="10" class="tw-text-center tw-py-6 tw-text-gray-500">No stock data available</td></tr>`;
    };
    const createChemicalRow = (itemName = "", qty = "", uom = "") => {
      const row = document.createElement("div");
      row.className = "chemical-row";
      const chemicalInput = document.createElement("input");
      chemicalInput.type = "text";
      chemicalInput.className = "tw-chemical-name-input form-input";
      chemicalInput.value = itemName;
      chemicalInput.placeholder = "Chemical";
      chemicalInput.readOnly = !!itemName;
      chemicalInput.addEventListener("focus", (e) => {
        showPopup(e.target, state.allChemicals.map(i => i.item_name || i));
      });
      const qtyInput = document.createElement("input");
      qtyInput.type = "number";
      qtyInput.className = "tw-chemical-qty-input form-input";
      qtyInput.value = qty;
      qtyInput.min = "0";
      qtyInput.step = "0.01";
      const uomInput = document.createElement("input");
      uomInput.type = "text";
      uomInput.className = "tw-chemical-uom-input form-input";
      uomInput.value = uom;
      uomInput.placeholder = "UoM";
      uomInput.readOnly = true;
      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "btn-remove";
      removeBtn.innerHTML = "&times;";
      removeBtn.addEventListener("click", () => {
        row.remove();
        updateStockBalances();
      });
      row.appendChild(chemicalInput);
      row.appendChild(qtyInput);
      row.appendChild(uomInput);
      row.appendChild(removeBtn);
      return row;
    };
    // ==================== FIX 2: getActiveFilters FROM CHECKBOXES ====================
    const getActiveFilters = () => {
      const activeObs = {};
      state.activeObservationTypes.forEach(obsType => {
        const checked = els.targetsContainer.querySelectorAll(`input[data-obs-type="${obsType}"]:checked`);
        activeObs[obsType] = Array.from(checked).map(cb => cb.value);
      });
      const activeStages = Array.from(els.stagesContainer.querySelectorAll('input:checked')).map(cb => cb.value);
      const activeSections = Array.from(els.plantSectionContainer.querySelectorAll('input:checked')).map(cb => cb.value);
      const activeRequirements = Array.from(els.thresholdContainer.querySelectorAll('input:checked')).map(cb => cb.value);
      return { activeObs, activeStages, activeSections, activeRequirements };
    };
    // ==================== DATA FETCHING ====================
    const fetchScoutingData = async (greenhouse) => {
      els.heatmapGridWrapper.classList.add("tw-hidden");
      els.targetsContainer.innerHTML = '';
      els.stagesContainer.innerHTML = "";
      els.plantSectionContainer.innerHTML = "";
      els.variety.innerHTML = '<option value="">Select variety</option>';
      els.bom.innerHTML = '<option value="">Select BOM</option>';
      els.bomDetailsContainer.classList.add("tw-hidden");
      renderGrid(0, 0);
      showLoader();
      try {
        const dateValue = document.getElementById('scouting-date').value || new Date().toISOString().slice(0, 10);
        const response = await fetch('/api/method/upande_scp.serverscripts.get_scouting_report.getScoutingData', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Frappe-CSRF-Token': "{{csrf_token}}"
          },
          body: JSON.stringify({ greenhouse, date: dateValue })
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const r = await response.json();
        const data = r.message || r.data;
        if (data && data.scouting_entries && data.scouting_entries.length > 0) {
          state.scoutingData = data.scouting_entries;
          // ---- Discover all observation types present in data ----
          const discoveredTypes = new Set();
          state.scoutingData.forEach(entry => {
            Object.keys(entry).forEach(key => {
              if (key.endsWith('_scouting_entry') && Array.isArray(entry[key]) && entry[key].length > 0) {
                discoveredTypes.add(key);
              }
            });
          });
          // ---- Merge metadata types + discovered types ----
          if (data.observation_metadata) {
            state.observationMetadata = data.observation_metadata;
            state.allObservationNames = data.observation_metadata.all_observation_names || {};
            const metadataTypes = data.observation_metadata.active_observation_types || [];
            state.activeObservationTypes = [...new Set([...metadataTypes, ...discoveredTypes])];
          } else {
            state.observationMetadata = { type_labels: {}, active_observation_types: [], all_observation_names: {} };
            state.allObservationNames = {};
            state.activeObservationTypes = Array.from(discoveredTypes);
          }
          // ==================== FIX 3: IN SCOPE + PROCESS DATA ====================
          const { dataMap, observationsInGreenhouse, stagesInGreenhouse, sectionsInGreenhouse } = processScoutingData(data.scouting_entries);
          state.dataMap = dataMap;
          // ==================== RENDER FILTERS ====================
          renderObservationCheckboxes(observationsInGreenhouse);
          renderStageCheckboxes([...stagesInGreenhouse]);
          renderPlantSectionCheckboxes([...sectionsInGreenhouse]);
          // ==================== RENDER GRID ====================
          if (data.varieties) populateVarieties(data.varieties);
          if (data.susceptibility) {
            state.susceptibilityData = data.susceptibility;
          }
          if (data.spray_team_team) {
            populateTeams(data.spray_team_team);
            state.teamData = data.spray_team_team.map(v => v.name);
          }
          const { maxBed, maxZone } = findMaxDimensions(state.scoutingData);
          const bedNumbering = data.custom_bed_numbering || "Top to Bottom";
          const zoneNumbering = data.custom_zone_numbering || "Right to Left";
          renderGrid(maxBed, maxZone, bedNumbering, zoneNumbering);
          // ==================== FIX 4: INITIAL UPDATE ====================
          updateGrid();
          els.heatmapGridWrapper.classList.remove("tw-hidden");
          if (data.boms) {
            state.bomsData = data.boms;
            state.bomItems = data.bom_items;
            state.allChemicals = data.all_chemicals ? [...new Set(data.all_chemicals)].sort() : [];
            populateBoms(state.bomsData);
          }
          renderThresholdCheckboxes(els.variety.value);
          state.bedData = data.bed_data || [];
        } else {
          els.heatmapGridWrapper.classList.add("tw-hidden");
        }
      } catch (error) {
        els.heatmapGridWrapper.classList.add("tw-hidden");
      } finally {
        hideLoader();
      }
    };
    const updateStockBalances = async () => {
      const chemicals = getFinalChemicals();
      const uniqueChemicals = [...new Set(chemicals.map(c => c.chemical).filter(name => name && name.trim()))];
      if (uniqueChemicals.length === 0) {
        els.stockBalanceTableBody.innerHTML = '<tr><td colspan="10" class="tw-text-center tw-py-6 tw-text-red-500">No chemicals to check</td></tr>';
        return;
      }
      els.stockBalanceTableBody.innerHTML = '<tr><td colspan="10" class="tw-text-center tw-py-6 tw-text-gray-500">Fetching stock balances...</td></tr>';
      showLoader();
      try {
        const response = await fetch('/api/method/getBomStockBalances', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Frappe-CSRF-Token': "{{csrf_token}}"
          },
          body: JSON.stringify({ data: JSON.stringify({ chemicals: uniqueChemicals }) })
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const r = await response.json();
        const data = r.message || r.data;
        if (data) {
          const stockData = data.stock_balances;
          if (data.item_uom_map) {
            state.chemicalUomCache = { ...state.chemicalUomCache, ...data.item_uom_map };
            refreshRowUoms();
          }
          if (stockData) {
            const firstItem = Object.keys(stockData)[0];
            const allWarehouses = firstItem ? Object.keys(stockData[firstItem]) : [];
            renderStockTable(stockData, allWarehouses);
          } else {
            els.stockBalanceTableBody.innerHTML = '<tr><td colspan="10" class="tw-text-center tw-py-6 tw-text-gray-500">No stock data found</td></tr>';
          }
        } else {
          els.stockBalanceTableBody.innerHTML = '<tr><td colspan="10" class="tw-text-center tw-py-6 tw-text-gray-500">No stock data found</td></tr>';
        }
      } catch (error) {
        els.stockBalanceTableBody.innerHTML = '<tr><td colspan="10" class="tw-text-center tw-py-6 tw-text-red-500">Error fetching stock balances</td></tr>';
      } finally {
        hideLoader();
      }
    };
    // ==================== HELPER FUNCTIONS ====================
    const populateVarieties = (varieties) => {
      els.variety.innerHTML = '<option value="">Select variety</option>';
      els.varietyMultiSelect.innerHTML = "";
      varieties.forEach((v) => {
        const option = document.createElement("option");
        option.value = v.name;
        option.textContent = v.name;
        els.variety.appendChild(option);
        const multiOption = option.cloneNode(true);
        els.varietyMultiSelect.appendChild(multiOption);
      });
    };
    const populateTeams = (teams) => {
      els.sprayTeam.innerHTML = "";
      teams.forEach((team) => {
        const option = document.createElement("option");
        option.value = team.name;
        option.textContent = team.name;
        els.sprayTeam.appendChild(option);
      });
    };
    const populateBoms = (boms) => {
      els.bom.innerHTML = '<option value="">Select BOM</option>';
      boms.forEach((b) => {
        const option = document.createElement("option");
        option.value = b.name;
        option.textContent = b.name;
        els.bom.appendChild(option);
      });
    };
    const populateBomDetails = (bomName) => {
      const selectedBom = state.bomsData.find((bom) => bom.name === bomName);
      els.bomChemicalsList.innerHTML = "";
      if (selectedBom) {
        els.bomDetailsContainer.classList.remove("tw-hidden");
        els.waterPh.value = selectedBom.custom_water_ph || "";
        els.waterHardness.value = selectedBom.custom_water_hardness || "";
        const chemicals = state.bomItems.filter((item) => item.parent === bomName);
        chemicals.forEach((item) => {
          const row = createChemicalRow(item.item_name, item.qty, item.uom);
          els.bomChemicalsList.appendChild(row);
        });
      } else {
        els.bomDetailsContainer.classList.add("tw-hidden");
      }
    };
    const calculateAreaToSpray = () => {
      const scope = els.scope.value;
      let totalAreaSqMeters = 0;
      if (scope === "Full Greenhouse") {
        totalAreaSqMeters = state.bedData.reduce((sum, d) => sum + (d.bed__area || 0), 0);
      } else if (scope === "Specific Variety") {
        const selectedVarietyNames = Array.from(els.varietyMultiSelect.selectedOptions).map(opt => opt.value);
        if (selectedVarietyNames.length > 0) {
          const accountedVarieties = new Set();
          state.bedData.forEach((d) => {
            if (selectedVarietyNames.includes(d.variety) && !accountedVarieties.has(d.variety) && d.total_variety_area > 0) {
              totalAreaSqMeters += d.total_variety_area;
              accountedVarieties.add(d.variety);
            }
          });
        }
      } else if (scope === "Specific Bed(s)") {
        const bedString = els.bedNumbers.value.trim();
        if (bedString) {
          const targetBeds = new Set();
          const segments = bedString.split(",").map(s => s.trim()).filter(s => s.length > 0);
          segments.forEach((segment) => {
            const rangeMatch = segment.match(/^(\d+)\s*-\s*(\d+)$/);
            if (rangeMatch) {
              const start = parseInt(rangeMatch[1]);
              const end = parseInt(rangeMatch[2]);
              for (let i = start; i <= end; i++) targetBeds.add(String(i));
            } else {
              const singleBed = segment.match(/^(\d+)$/);
              if (singleBed) targetBeds.add(singleBed[1]);
            }
          });
          state.bedData.forEach((d) => {
            if (targetBeds.has(d.bed)) totalAreaSqMeters += d.bed__area || 0;
          });
        }
      }
      const totalAreaHectares = totalAreaSqMeters > 0 ? totalAreaSqMeters / 10000 : 0;
      els.areaToSpray.value = totalAreaHectares > 0 ? totalAreaHectares.toFixed(4) : 0;
    };
    const getFinalChemicals = () => {
      const chemicalRows = Array.from(els.bomChemicalsList.querySelectorAll(".chemical-row"));
      return chemicalRows.map(row => {
        const chemicalInput = row.querySelector(".tw-chemical-name-input");
        const qtyInput = row.querySelector(".tw-chemical-qty-input");
        const uomInput = row.querySelector(".tw-chemical-uom-input");
        const chemicalName = chemicalInput ? chemicalInput.value.trim() : '';
        const warehouseData = state.sourceWarehouseCache[chemicalName] || {};
        return {
          chemical: chemicalName,
          quantity: qtyInput ? parseFloat(qtyInput.value) : 0,
          uom: uomInput ? uomInput.value : '',
          source_warehouse: warehouseData.source_warehouse || null
        };
      }).filter(item => item.chemical !== '');
    };
    const refreshRowUoms = () => {
      const rows = document.querySelectorAll(".chemical-row");
      rows.forEach(row => {
        const chemicalInput = row.querySelector(".tw-chemical-name-input");
        const uomInput = row.querySelector(".tw-chemical-uom-input");
        const chemicalName = chemicalInput.value;
        if (chemicalName && state.chemicalUomCache[chemicalName]) {
          uomInput.value = state.chemicalUomCache[chemicalName];
        }
      });
    };
    // ==================== EVENT HANDLERS ====================
    window.handleWarehouseChange = function (element) {
      const itemCode = element.getAttribute("data-item-code");
      const warehouse = element.value;
      if (state.sourceWarehouseCache[itemCode]) {
        state.sourceWarehouseCache[itemCode].source_warehouse = warehouse || null;
      }
    };
    els.greenhouse.addEventListener("change", (e) => {
      if (e.target.value) {
        els.variety.value = "";
        els.sprayType.value = "";
        els.kit.value = "";
        els.scope.value = "";
        els.bom.value = "";
        els.waterPh.value = "";
        els.waterHardness.value = "";
        els.waterVolume.value = "";
        els.areaToSpray.value = "";
        els.bomDetailsContainer.classList.add("tw-hidden");
        els.bomChemicalsList.innerHTML = "";
        els.stockBalancesContainer.classList.add("tw-hidden");
        els.stockBalanceTableBody.innerHTML = '<tr><td colspan="10" class="tw-text-center tw-py-4 tw-text-gray-500">Loading...</td></tr>';
        els.warehouseHeadersRow.innerHTML = "";
      }
      fetchScoutingData(e.target.value);
    });
    els.variety.addEventListener("change", () => {
      renderThresholdCheckboxes(els.variety.value);
      updateGrid();
    });
    els.scope.addEventListener("change", (e) => {
      els.bedNumbersContainer.classList.add("tw-hidden");
      els.varietySelectionContainer.classList.add("tw-hidden");
      els.bedNumbers.value = "";
      els.varietyMultiSelect.selectedIndex = -1;
      els.selectedVarietiesDisplay.innerHTML = '<p class="tw-text-gray-500">Selected varieties will appear here...</p>';
      if (e.target.value === "Specific Bed(s)") {
        els.bedNumbersContainer.classList.remove("tw-hidden");
      } else if (e.target.value === "Specific Variety") {
        els.varietySelectionContainer.classList.remove("tw-hidden");
      }
      calculateAreaToSpray();
    });
    els.varietyMultiSelect.addEventListener("change", () => {
      const selectedOptions = Array.from(els.varietyMultiSelect.selectedOptions);
      const selectedVarietyNames = selectedOptions.map(opt => opt.textContent);
      els.selectedVarietiesDisplay.innerHTML = selectedVarietyNames.length > 0
        ? `<p class="tw-font-semibold">Selected:</p> ${selectedVarietyNames.join(", ")}`
        : '<p class="tw-text-gray-500">Selected varieties will appear here...</p>';
      calculateAreaToSpray();
    });
    els.bedNumbers.addEventListener("input", calculateAreaToSpray);
    els.bom.addEventListener("change", (e) => {
      populateBomDetails(e.target.value);
      const uniqueChemicals = state.bomItems
        .filter(item => item.parent === e.target.value)
        .map(item => item.item_name);
      updateStockBalances();
    });
    els.addChemicalBtn.addEventListener("click", () => {
      const newRow = createChemicalRow();
      els.bomChemicalsList.appendChild(newRow);
    });
    els.targetsContainer.addEventListener("change", updateGrid);
    els.stagesContainer.addEventListener("change", updateGrid);
    els.plantSectionContainer.addEventListener("change", updateGrid);
    els.thresholdContainer.addEventListener("change", updateGrid);
    els.popupOverlay.addEventListener("click", (e) => {
      if (e.target.id === "global-popup-overlay") {
        els.popupOverlay.classList.remove("active");
      }
    });
    // ==================== FORM SUBMISSION ====================
    document.getElementById("spray-plan-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const greenhouse = els.greenhouse.value;
      const variety = els.variety.value;
      const sprayType = els.sprayType.value;
      const kit = els.kit.value;
      const scope = els.scope.value;
      const bom = els.bom.value;
      const waterPh = els.waterPh.value;
      const waterHardness = els.waterHardness.value;
      const waterVolume = els.waterVolume.value;
      const areaToSpray = els.areaToSpray.value;
      const sprayTeam = els.sprayTeam.value;
      const { activeObs, activeStages, activeSections } = getActiveFilters();
      const targets = [];
      Object.values(activeObs).forEach(obsArray => {
        targets.push(...obsArray);
      });
      const chemicals = getFinalChemicals();
      if (!greenhouse || !variety || targets.length === 0 || activeStages.length === 0 || activeSections.length === 0 || !sprayType || !kit || !scope || !bom) {
        frappe.msgprint("Please fill out all required fields.");
        return;
      }
      if (chemicals.length === 0) {
        frappe.msgprint("Please add at least one chemical.");
        return;
      }
      for (const chemical of chemicals) {
        if (!chemical.chemical || !chemical.uom || chemical.quantity <= 0 || !chemical.source_warehouse) {
          frappe.msgprint("All chemical rows must have valid item name, quantity, UoM, and source warehouse.");
          return;
        }
      }
      if (!waterPh || !waterHardness) {
        frappe.msgprint("Please provide values for water pH and water hardness.");
        return;
      }
      let custom_scope_value = "";
      if (scope === "Specific Variety") {
        const selectedVarieties = Array.from(els.varietyMultiSelect.selectedOptions).map(opt => opt.value);
        custom_scope_value = selectedVarieties.join(",");
      } else if (scope === "Specific Bed(s)") {
        custom_scope_value = els.bedNumbers.value;
      }
      const formData = {
        custom_type: "Application Floor Plan",
        custom_greenhouse: greenhouse,
        custom_variety: variety,
        custom_targets: targets,
        custom_stages: activeStages,
        custom_plant_sections: activeSections,
        custom_spray_type: sprayType,
        custom_kit: kit,
        custom_scope: scope,
        custom_scope_details: custom_scope_value,
        production_item: bom,
        qty: 1,
        custom_water_ph: parseFloat(waterPh) || 0,
        custom_water_hardness: parseFloat(waterHardness) || 0,
        chemicals: chemicals,
        custom_water_volume: waterVolume,
        custom_area: areaToSpray,
        custom_spray_team: sprayTeam
      };
      frappe.call({
        method: 'preValidateFracIracGuidelines',
        args: { raw_data: formData },
        callback: function (r) {
          const res = r.message;
          if (res?.status === "success") {
            frappe.show_alert({ message: __("Work Order created successfully."), indicator: "green" });
            frappe.set_route('List', 'Work Order');
            return;
          }
          if (res?.status === "validation_failed") {
            const dialog = new frappe.ui.Dialog({
              title: __('FRAC/IRAC Validation Warning'),
              size: 'large',
              primary_action_label: __('Bypass and Create'),
              primary_action: function () {
                dialog.hide();
                frappe.show_alert({ message: __('Creating Work Order (Guidelines Bypassed)'), indicator: 'orange' });
                createWorkOrder(formData);
              },
              secondary_action_label: __('Cancel'),
              secondary_action: function () {
                dialog.hide();
                frappe.show_alert({ message: __('Work Order creation cancelled'), indicator: 'red' });
              }
            });
            const html = `
            <div style="max-height: 400px; overflow-y: auto;">
              ${res.html || '<div>No validation details provided.</div>'}
              <div style="margin-top: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                <p style="margin: 0; color: #856404; font-weight: bold;">
                  Warning: Do you want to bypass these guidelines and create the Work Order anyway?
                </p>
                <p style="margin: 10px 0 0 0; color: #856404; font-size: 0.9em;">
                  Bypassing may lead to reduced effectiveness and increased resistance.
                </p>
              </div>
            </div>
          `;
            dialog.body.innerHTML = html;
            dialog.show();
            dialog.$wrapper.find('.btn-primary').removeClass('btn-primary').addClass('btn-dark');
            return;
          }
          frappe.msgprint({ title: __('Validation Error'), indicator: 'red', message: __('Unexpected response from server.') });
        },
        error: function (err) {
          frappe.msgprint({ title: __('Server Error'), indicator: 'red', message: __('An error occurred. Please try again.') });
        }
      });
    });
    const createWorkOrder = (data) => {
      frappe.call({
        method: "createChemicalPlanWorkOrder",
        args: data,
        callback: function (r) {
          if (r.message && r.message.status === "success") {
            frappe.msgprint(`Work Order ${r.message.work_order_name} created successfully!`);
            location.reload();
          } else {
            frappe.msgprint(`Error creating Work Order: ${r.message?.message || "Unknown error"}`);
          }
        },
        error: function () {
          frappe.msgprint("An unexpected error occurred during creation. Please try again.");
        }
      });
    };
    // ==================== INITIALIZATION ====================
    renderThresholdCheckboxes(null);
  });
</script>
{% endblock %}