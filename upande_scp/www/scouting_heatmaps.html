{% extends "upande_scp/www/map_base.html" %}

{% block head %}
<style>
    :root {
        --bg: #ffffff;
        --text: #1f2937;
        --border: #d1d5db;
        --sidebar-bg: #f3f4f6;
        --sidebar-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        --accent: #4b5563;
        --accent-hover: #374151;
        --hover: #e5e7eb;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f9fafb;
    }

    #dashboard-page {
        height: 100vh;
        width: 100%;
        display: flex;
        position: relative;
        overflow: hidden;
    }

    #content-container {
        flex: 1;
        position: relative;
        z-index: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }

    #sidebar {
        position: relative;
        width: 320px;
        height: 100%;
        background: var(--sidebar-bg);
        border-left: 1px solid var(--border);
        box-shadow: var(--sidebar-shadow);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        flex-shrink: 0;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .section {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .section-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .gh-filter-tabs {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--bg);
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
    }

    .gh-btn,
    .farm-btn {
        padding: 0.625rem 0.875rem;
        border: 1.5px solid var(--border);
        background: var(--sidebar-bg);
        color: var(--text);
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
        position: relative;
    }

    .gh-btn:hover:not(.active),
    .farm-btn:hover:not(.active) {
        border-color: var(--accent);
        transform: translateY(-1px);
    }

    .gh-btn.active,
    .farm-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
        box-shadow: 0 4px 12px rgba(75, 85, 99, 0.3);
    }

    /* --- Heatmap Specific Styles Revamp --- */

    .heatmap-container {
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--bg);
        overflow: hidden;
    }

    .heatmap-grid {
        display: grid;
        gap: 1px;
    }

    .grid-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 20px;
        font-size: 10px;
        font-weight: 500;
        color: #fff;
        transition: all 0.15s ease-out;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);
    }

    .zone-header-cell,
    .bed-label-cell {
        background: var(--sidebar-bg);
        color: var(--text);
        font-weight: 600;
        font-size: 10px;
        padding: 2px 5px;
        border-radius: 0;
        box-shadow: none;
    }

    .bed-label-cell {
        justify-content: flex-end;
        height: 20px;
    }

    .zone-header-cell {
        justify-content: center;
        height: 20px;
    }

    .data-cell {
        height: 20px;
        border-radius: 2px;
        cursor: pointer;
        position: relative;
    }

    .data-cell:hover {
        transform: scale(1.1);
        z-index: 10;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .legend {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e5e7eb;
        font-size: 11px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .legend-box {
        width: 15px;
        height: 10px;
        border-radius: 2px;
    }

    .stage-legend {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        margin-top: 5px;
        padding: 5px;
        background: #f9fafb;
        border-radius: 6px;
    }

    .stage-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 11px;
        padding: 2px 6px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
    }

    .intensity-0 {
        opacity: 1;
        background: #e5e7eb !important;
        cursor: default;
    }

    .intensity-1 {
        opacity: 0.2;
    }

    .intensity-2 {
        opacity: 0.4;
    }

    .intensity-3 {
        opacity: 0.6;
    }

    .intensity-4 {
        opacity: 0.8;
    }

    .intensity-5 {
        opacity: 1;
    }

    .optimized-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
    }

    .heatmap-card {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 10px;
        transition: box-shadow 0.3s;
        cursor: pointer;
        position: relative;
        background: white;
    }

    .heatmap-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .mini-heatmap-wrapper {
        overflow: visible;
        position: relative;
        height: auto;
        width: 100%;
    }

    .mini-heatmap-grid {
        width: 100%;
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .modal.hidden {
        display: none;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 90vw;
        max-height: 90vh;
        width: 1200px;
        overflow: auto;
        padding: 30px;
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 32px;
        color: #6b7280;
        background: none;
        border: none;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-close:hover {
        color: #1f2937;
    }

    .loader {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
    }

    .loader.hidden {
        display: none;
    }

    .loader-spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #4b5563;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
        grid-column: 1 / -1;
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block page_content %}
<div>
    <div id="dashboard-page">
        <div id="content-container">
            <div class="max-w-7xl mx-auto">
                <div id="heatmaps-container">
                    <div class="optimized-grid" id="current-gh-heatmaps"></div>
                </div>
            </div>
        </div>

        <div id="sidebar">
            <div class="sidebar-content">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Filters</h2>

                <div class="section">
                    <label class="section-label">Observation Date</label>
                    <input type="date" id="scout-date-picker" class="gh-btn" />
                </div>

                <div class="section">
                    <label class="section-label">Select Farm</label>
                    <div class="gh-filter-tabs" id="farm-filter"></div>
                </div>

                <div class="section">
                    <label class="section-label">Select Greenhouse</label>
                    <div class="gh-filter-tabs" id="greenhouse-filter"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="heatmap-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close" id="modal-close">×</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="loader" class="loader hidden">
        <div class="loader-spinner"></div>
    </div>

    <script>
        let observationData = [];
        let observationTypes = {};
        let farmsData = [];
        let currentFarm = '';
        let currentGreenhouse = '';
        let currentDate = new Date().toISOString().split('T')[0];
        // Variables for grid dimensions are now dynamically set after fetching data
        let maxZoneCount = 0; 
        let maxBedCount = 0;

        function showLoader() {
            document.getElementById('loader').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('loader').classList.add('hidden');
        }

        const fetchGreenhouseData = (date, greenhouse) => {
            showLoader();

            fetch('/api/method/upande_scp.serverscripts.get_heatmap_data.getHeatmapData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Frappe-CSRF-Token': "{{csrf_token}}"
                },
                body: JSON.stringify({ date, greenhouse })
            })
                .then(r => r.ok ? r.json() : Promise.reject(r))
                .then(response => {
                    const data = response.message;

                    if (!data.scouting_entries || data.scouting_entries.length === 0) {
                        showEmptyState();
                        return;
                    }

                    observationData = data.scouting_entries;
                    observationTypes = data.observation_types;

                    // Set dynamic counts from backend
                    maxBedCount = data.bed_count || 50;
                    maxZoneCount = data.zone_count || 10;

                    renderHeatmaps(greenhouse);
                })
                .catch(err => {
                    console.error('Error fetching data:', err);
                    showEmptyState();
                })
                .finally(hideLoader);
        };

        function showEmptyState() {
            const container = document.getElementById('current-gh-heatmaps');
            container.innerHTML = `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                    </svg>
                    <p style="font-weight: 600; margin-bottom: 8px;">No Data Available</p>
                    <p>No scouting entries found for this date and greenhouse.</p>
                </div>
            `;
        }

        function getIntensityClass(count, max) {
            if (count === 0) return 'intensity-0';
            const r = count / max;
            if (r <= 0.2) return 'intensity-1';
            if (r <= 0.4) return 'intensity-2';
            if (r <= 0.6) return 'intensity-3';
            if (r <= 0.8) return 'intensity-4';
            return 'intensity-5';
        }

        function parseZone(zoneStr) {
            const m = zoneStr.match(/^(.+?)\s+-\s+Bed\s+(\d+)\s+-\s+Zone\s+(\d+)$/);
            if (!m) {
                return null;
            }
            return {
                gh: m[1].trim(),
                bed: +m[2],
                zone: +m[3]
            };
        }

        function calculateHeatmapMatrix(gh, observationName, observationType) {
            const data = observationData.filter(o => {
                const parsed = parseZone(o.zone);
                return parsed && parsed.gh === gh;
            });

            const matrix = {};
            let maxCount = 0;
            let total = 0;
            const stageBreakdown = {};

            const typeKey = getTypeKey(observationType);

            data.forEach(o => {
                const p = parseZone(o.zone);
                if (!p) return;

                const entries = o[typeKey] || [];
                const matchingEntries = entries.filter(e => e.name === observationName);

                let cnt = 0;
                matchingEntries.forEach(entry => {
                    const count = entry.count || 1;
                    cnt += count;

                    const stage = entry.stage || 'Present';
                    if (!stageBreakdown[stage]) stageBreakdown[stage] = 0;
                    stageBreakdown[stage] += count;
                });

                if (!matrix[p.bed]) matrix[p.bed] = {};
                matrix[p.bed][p.zone] = cnt;

                if (cnt > 0) {
                    maxCount = Math.max(maxCount, cnt);
                    total += cnt;
                }
            });

            return { matrix, maxCount, total, stageBreakdown };
        }

        function getTypeKey(observationType) {
            const typeMap = {
                'pests': 'pests_scouting_entry',
                'diseases': 'diseases_scouting_entry',
                'predators': 'predators_scouting_entry',
                'weeds': 'weeds_scouting_entry',
                'incidents': 'incidents_scouting_entry',
                'physiological_disorders': 'physiological_disorders_entry'
            };
            return typeMap[observationType] || observationType;
        }

        function renderHeatmapGrid(matrix, maxCount, color) {
            const grid = document.createElement('div');
            grid.className = 'heatmap-grid';

            grid.style.gridTemplateColumns = `50px repeat(${maxZoneCount}, 1fr)`;

            // 1. Top-Left Corner Cell (Empty)
            const corner = document.createElement('div');
            corner.className = 'grid-cell';
            grid.appendChild(corner);

            // 2. Zone Header Row (Zone maxZoneCount down to 1)
            for (let z = maxZoneCount; z >= 1; z--) {
                const lbl = document.createElement('div');
                lbl.className = 'grid-cell zone-header-cell';
                lbl.textContent = z;
                grid.appendChild(lbl);
            }

            // 3. Bed Rows (Bed maxBedCount down to 1)
            for (let bed = maxBedCount; bed >= 1; bed--) {
                // A. Bed Label Column
                const bedLbl = document.createElement('div');
                bedLbl.className = 'grid-cell bed-label-cell';
                bedLbl.textContent = bed;
                grid.appendChild(bedLbl);

                // B. Zone Data Cells (Zone maxZoneCount down to 1)
                for (let zone = maxZoneCount; zone >= 1; zone--) {
                    const cnt = (matrix[bed] && matrix[bed][zone]) || 0;
                    const cellDiv = document.createElement('div');
                    
                    cellDiv.className = `grid-cell data-cell ${getIntensityClass(cnt, maxCount)}`;
                    
                    if (cnt > 0 && maxCount > 0) {
                         cellDiv.style.backgroundColor = color;
                    }
                    
                    cellDiv.title = `Bed ${bed} – Zone ${zone}: ${cnt}`;

                    if (cnt === 0) {
                        cellDiv.style.backgroundColor = '';
                        cellDiv.title = `Bed ${bed} – Zone ${zone}: None`;
                    }
                    
                    grid.appendChild(cellDiv);
                }
            }

            const container = document.createElement('div');
            container.className = 'heatmap-container';
            container.appendChild(grid);
            return container;
        }

        function buildHeatmapCard(gh, observationName, observationType) {
            const metadata = observationTypes[observationType]?.[observationName];
            if (!metadata) return null;

            const { matrix, maxCount, total, stageBreakdown } = calculateHeatmapMatrix(gh, observationName, observationType);

            if (total === 0) return null;

            const card = document.createElement('div');
            card.className = 'heatmap-card';
            card.addEventListener('click', () => openModal(gh, observationName, observationType, metadata, matrix, maxCount, total, stageBreakdown));

            const header = document.createElement('div');
            header.style.marginBottom = '10px';
            header.innerHTML = `
                <p style="font-weight: 600; color: ${metadata.color}; font-size: 14px; margin-bottom: 4px;">${observationName}</p>
                <p style="font-size: 12px; color: #6b7280;">Total: ${total}</p>
            `;
            card.appendChild(header);

            const wrapper = document.createElement('div');
            wrapper.className = 'mini-heatmap-wrapper';

            const miniGrid = renderHeatmapGrid(matrix, maxCount, metadata.color);
            wrapper.appendChild(miniGrid);
            card.appendChild(wrapper);

            return card;
        }

        const modal = document.getElementById('heatmap-modal');
        const modalBody = document.getElementById('modal-body');

        document.getElementById('modal-close').addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });

        function openModal(gh, observationName, observationType, metadata, matrix, maxCount, total, stageBreakdown) {
            modalBody.innerHTML = '';

            const header = document.createElement('div');
            header.style.marginBottom = '20px';
            header.innerHTML = `
                <h2 style="font-size: 24px; font-weight: 700; color: ${metadata.color}; margin-bottom: 8px;">${observationName}</h2>
                <p style="font-size: 14px; color: #6b7280;">${gh} | Date: ${currentDate} | Total Count: ${total}</p>
            `;
            modalBody.appendChild(header);

            if (metadata.stages && metadata.stages.length > 0) {
                const stageLegendDiv = document.createElement('div');
                stageLegendDiv.className = 'stage-legend';

                const title = document.createElement('div');
                title.style.fontWeight = '600';
                title.style.fontSize = '13px';
                title.style.marginBottom = '8px';
                title.style.width = '100%';
                title.textContent = 'Stages Breakdown:';
                stageLegendDiv.appendChild(title);

                metadata.stages.forEach(stage => {
                    const stageItem = document.createElement('div');
                    stageItem.className = 'stage-item';
                    const stageCount = stageBreakdown[stage.stage] || 0;
                    stageItem.innerHTML = `
                        ${stage.symbol ? `<span style="font-size: 16px;">${stage.symbol}</span>` : ''}
                        <span>${stage.stage}</span>
                        <span style="font-size: 11px; color: #9ca3af;">(${stageCount})</span>
                    `;
                    stageLegendDiv.appendChild(stageItem);
                });
                modalBody.appendChild(stageLegendDiv);
            }

            const fullGridContainer = renderHeatmapGrid(matrix, maxCount, metadata.color);
            fullGridContainer.style.marginTop = '20px';
            modalBody.appendChild(fullGridContainer);

            const legend = document.createElement('div');
            legend.className = 'legend';
            legend.style.marginTop = '20px';
            legend.innerHTML = `
                <div class="legend-item"><div class="legend-box intensity-0" style="background:${metadata.color};"></div><span>None (0)</span></div>
                <div class="legend-item"><div class="legend-box intensity-2" style="background:${metadata.color};"></div><span>Low</span></div>
                <div class="legend-item"><div class="legend-box intensity-4" style="background:${metadata.color};"></div><span>Medium</span></div>
                <div class="legend-item"><div class="legend-box intensity-5" style="background:${metadata.color};"></div><span>High</span></div>
                <div style="margin-left: auto; font-weight: 600;">Max: ${maxCount}</div>
            `;
            modalBody.appendChild(legend);

            modal.classList.remove('hidden');
        }

        function renderHeatmaps(gh) {
            const container = document.getElementById('current-gh-heatmaps');
            container.innerHTML = '';

            let hasData = false;

            Object.keys(observationTypes).forEach(observationType => {
                const observations = observationTypes[observationType];
                Object.keys(observations).forEach(observationName => {
                    const card = buildHeatmapCard(gh, observationName, observationType);
                    if (card) {
                        container.appendChild(card);
                        hasData = true;
                    }
                });
            });

            if (!hasData) {
                showEmptyState();
            }
        }

        function setupFarmFilter() {
            const filterContainer = document.getElementById('farm-filter');
            filterContainer.innerHTML = '';

            farmsData.forEach(farm => {
                const button = document.createElement('button');
                button.className = 'farm-btn';
                button.textContent = farm.name;

                if (farm.name === currentFarm) {
                    button.classList.add('active');
                }

                button.addEventListener('click', () => {
                    document.querySelectorAll('.farm-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    currentFarm = farm.name;
                    setupGreenhouseFilter();

                    const farmGreenhouses = farmsData.find(f => f.name === currentFarm)?.greenhouses || [];
                    if (farmGreenhouses.length > 0) {
                        currentGreenhouse = farmGreenhouses[0].name;
                        fetchGreenhouseData(currentDate, currentGreenhouse);
                    }
                });

                filterContainer.appendChild(button);
            });
        }

        function setupGreenhouseFilter() {
            const filterContainer = document.getElementById('greenhouse-filter');
            filterContainer.innerHTML = '';

            const farm = farmsData.find(f => f.name === currentFarm);
            if (!farm || !farm.greenhouses) return;

            farm.greenhouses.forEach(gh => {
                const button = document.createElement('button');
                button.className = 'gh-btn';
                button.textContent = gh.name;

                if (gh.name === currentGreenhouse) {
                    button.classList.add('active');
                }

                button.addEventListener('click', () => {
                    document.querySelectorAll('.gh-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    currentGreenhouse = gh.name;
                    fetchGreenhouseData(currentDate, currentGreenhouse);
                });

                filterContainer.appendChild(button);
            });
        }

        document.getElementById('scout-date-picker').addEventListener('change', (e) => {
            currentDate = e.target.value;
            if (currentGreenhouse) {
                fetchGreenhouseData(currentDate, currentGreenhouse);
            }
        });

        function initialize() {
            showLoader();

            document.getElementById('scout-date-picker').value = currentDate;

            fetch('/api/method/upande_scp.serverscripts.get_heatmap_data.getFarmsAndGreenhouses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Frappe-CSRF-Token': "{{csrf_token}}"
                }
            })
                .then(r => r.json())
                .then(response => {
                    farmsData = response.message.farms;

                    if (farmsData.length > 0) {
                        currentFarm = farmsData[0].name;
                        setupFarmFilter();

                        if (farmsData[0].greenhouses.length > 0) {
                            currentGreenhouse = farmsData[0].greenhouses[0].name;
                            setupGreenhouseFilter();
                            fetchGreenhouseData(currentDate, currentGreenhouse);
                        }
                    }
                })
                .catch(err => {
                    console.error('Error fetching farms:', err);
                    showEmptyState();
                })
                .finally(hideLoader);
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</div>
{% endblock %}